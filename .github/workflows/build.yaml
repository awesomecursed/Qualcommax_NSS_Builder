name: OpenWrt Build

on:
  workflow_dispatch:
  push:
    branches: [main]
  schedule:
    - cron: "0 */2 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  REMOTE_REPOSITORY: qosmio/openwrt-ipq
  REMOTE_BRANCH: main-nss
  NSS_PACKAGES_REPOSITORY: qosmio/nss-packages
  NSS_PACKAGES_REPOSITORY_BRANCH: NSS-12.5-K6.x
  CONFIG_FILE: ax3600.config
  CUSTOM_FILES_PATH: files
  RELEASE_PREFIX: main-nss
  ARTIFACT_RETENTION_DAYS: 7
  RELEASES_TO_KEEP: 2

jobs:
  check_updates:
    name: Check for Updates
    runs-on: ubuntu-24.04
    outputs:
      build_required: ${{ steps.check.outputs.build_required }}
      main_sha: ${{ steps.check.outputs.main_sha }}
      nss_sha: ${{ steps.check.outputs.nss_sha }}
    steps:
      - name: Check upstream changes
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          main_sha=$(gh api "repos/${REMOTE_REPOSITORY}/commits/${REMOTE_BRANCH}" --jq .sha)
          nss_sha=$(gh api "repos/${NSS_PACKAGES_REPOSITORY}/commits/${NSS_PACKAGES_REPOSITORY_BRANCH}" --jq .sha)
          latest_release_body=$(gh release view --repo "${GITHUB_REPOSITORY}" --json body --jq .body 2>/dev/null || echo "")
          build_required=true
          if [[ "${GITHUB_EVENT_NAME}" != "workflow_dispatch" ]] && [[ "$latest_release_body" == *"$main_sha"* ]] && [[ "$latest_release_body" == *"$nss_sha"* ]]; then
            build_required=false
          fi
          echo "build_required=$build_required" >> "$GITHUB_OUTPUT"
          echo "main_sha=$main_sha" >> "$GITHUB_OUTPUT"
          echo "nss_sha=$nss_sha" >> "$GITHUB_OUTPUT"

  build_firmware:
    name: Build Firmware
    needs: check_updates
    if: needs.check_updates.outputs.build_required == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    permissions:
      contents: write
    env:
      MAIN_SHA: ${{ needs.check_updates.outputs.main_sha }}
      NSS_SHA: ${{ needs.check_updates.outputs.nss_sha }}
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget

      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REMOTE_REPOSITORY }}
          ref: ${{ env.MAIN_SHA }}
          path: openwrt

      - name: Checkout builder assets
        uses: actions/checkout@v4
        with:
          path: builder_repo

      - name: Prepare build environment
        working-directory: openwrt
        run: |
          # 1. Настройка фидов
          cp feeds.conf.default feeds.conf
          echo "src-git qosmio https://github.com/qosmio/packages-extra" >> feeds.conf
          echo "src-git sqm_nss https://github.com/JuliusBairaktaris/sqm-scripts-nss" >> feeds.conf
          echo "src-git amnezia https://github.com/amnezia-vpn/amneziawg-openwrt.git" >> feeds.conf
          
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # 2. Настройка конфига
          cp "../builder_repo/${CONFIG_FILE}" .config
          echo "CONFIG_PACKAGE_kmod-amneziawg=y" >> .config
          echo "CONFIG_PACKAGE_amneziawg-tools=y" >> .config
          echo "CONFIG_PACKAGE_luci-proto-amneziawg=y" >> .config
          
          make defconfig

          # 3. Кастомные файлы
          if [ -d "../builder_repo/${CUSTOM_FILES_PATH}" ]; then
            mkdir -p files
            rsync -a "../builder_repo/${CUSTOM_FILES_PATH}/" files/
          fi

      - name: Build
        working-directory: openwrt
        run: |
          make download -j$(nproc)
          make -j$(nproc) || make -j1 V=s

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ax3600-amnezia-nss
          path: openwrt/bin/targets/qualcommax/ipq807x/*.bin

      - name: Publish release
        id: release
        run: |
          tag_name="nss-amnezia-$(date +%Y%m%d-%H%M)"
          gh release create "$tag_name" --title "AX3600 NSS + AmneziaWG" --notes "Build with NSS and AmneziaWG support" openwrt/bin/targets/qualcommax/ipq807x/*.bin
